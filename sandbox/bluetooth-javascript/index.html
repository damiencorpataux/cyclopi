<!DOCTYPE html>
<html>
    <head>
        <title>Microio UI</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div class="container py-4 px-4 px-md-0">
            <h1>
                <i class="text-success pe-auto" data-feather="cpu" stroke-width="2" width="32" height="32" style="position:relative; top: -3px; left:-3px"></i>
                Hello, io!
            </h1>
            <p>
                This is the <strong>UI for Microio</strong>.
            </p>

            <!-- Declared UI for microio controls. -->
            <hr class="my-4">
            <h2 class="fs-5">Bluetooth device characteristics <span class="text-muted">&mdash;have fun!</span></h2>
            <p>
                <div class="d-flex justify-content-between _align-items-center _flex-column flex-md-row">
                    <div>
                        <button id="connect" type="button" disabled class="btn btn-primary btn-lg" title="Connect">
                            <i data-feather="bluetooth"></i>
                        </button>
                    </div>
                    <div class="flex-fill bg-light rounded p-2 ms-2">
                        <span id="status">
                            ...
                        </span>
                    </div>
<!-- 
                    <div class="flex-fill bg-light m-2">
                        <button id="start_stop_logging_button" type="button" class="btn btn-secondary btn-lg">Start Logging</button>
                        Last observation: <span id="last_obs_time">xx:xx:xx</span>
                    </div>
 -->
                </div>
            </p>
            <p class="small text-muted">
                Example from <a href="https://github.com/Wave1art/ESP32-Web-Bluetooth">Wave1art</a>.
            </p>
            <hr class="my-4">
            <footer class="small text-end">
                <i data-feather="tool" class="text-secondary" style="width:16px"></i>
                <i data-feather="cpu" class="text-secondary" style="width:16px"></i>
                <i data-feather="codesandbox" class="text-secondary" style="width:16px"></i>
                Synesys Microio, 2023.
            </footer>
        </div>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
        <script src="https://unpkg.com/feather-icons"></script>
        <script>feather.replace()</script>

        <script>

            const runtime = {
                device: null,
                characteristics: {}
            };
            const config = {
                bt_service_id: '90D3D000',
                bt_uuid_suffix: 'C950-4DD6-9410-2B7AEB1DD7D8',
                bt: {}
            };
            config.bt.uuid = `${config.bt_service_id}-${config.bt_uuid_suffix}`;
            config.bt.datahandlers = {
                // string: (event) => Array.from(new Uint8Array(event.target.value.buffer)).map(v => String.fromCharCode(v)).join(''),
                string: (event) => new TextDecoder().decode(new Uint8Array(event.target.value.buffer)),
                sint16: (event) => String(event.target.value.getInt16(0, false) / 100),
                sint32: (event) => String(event.target.value.getInt32(0, false) / 1000),
                double: (event) => String(event.target.value.getFloat64(0, false).toFixed(6)),
            };
            config.bt.datasources = [
                [config.bt.uuid, `90D3D001-${config.bt_uuid_suffix}`, config.bt.datahandlers.string],
                [config.bt.uuid, `90D3D002-${config.bt_uuid_suffix}`, config.bt.datahandlers.sint16],
                // [config.bt.uuid, `90D3D003-${config.bt_uuid_suffix}`, config.bt.datahandlers.sint16],

                // [config.bt.uuid, `90D3D005-${config.bt_uuid_suffix}`, config.bt.datahandlers.double],
                // [config.bt.uuid, `90D3D006-${config.bt_uuid_suffix}`, config.bt.datahandlers.double],

                // [config.bt.uuid, `90D3D007-${config.bt_uuid_suffix}`, config.bt.datahandlers.sint16],
                // [config.bt.uuid, `90D3D008-${config.bt_uuid_suffix}`, config.bt.datahandlers.sint16],
                // [config.bt.uuid, `90D3D009-${config.bt_uuid_suffix}`, config.bt.datahandlers.sint16],
                // [config.bt.uuid, `90D3D00A-${config.bt_uuid_suffix}`, config.bt.datahandlers.sint16],
                // [config.bt.uuid, `90D3D00B-${config.bt_uuid_suffix}`, config.bt.datahandlers.sint16],
            ];
            const dom = {
                connect: document.querySelector('#connect'),
                status: document.querySelector('#status'),
            }
            document.addEventListener('DOMContentLoaded', () => {
                dom.connect.focus();
                init();
                setTimeout(() => {
                    dom.connect.disabled = false;
                    dom.status.innerHTML += ' Click to connect.'
                }, 1500);
                setInterval(() => {
                    // FIXME: This Is not received by server (aioble).
                    const characteristic = runtime.characteristics[`90D3D002-${config.bt_uuid_suffix}`]
                    if (characteristic) {
                        // FIXME
                        const value = new Uint8Array([0xff]);
                        // const value = new TextEncoder().encode('{"json":1}' + "\n");  // from: https://stackoverflow.com/a/62545865/1300775
                        characteristic.writeValueWithoutResponse(value);
                        // characteristic.writeValue(value);
                        console.debug('Write value', value, characteristic);
                    }
                }, 1500);
            });

            function init() {
                dom.status.innerHTML = 'Initializing...';
                navigator.bluetooth.getDevices().then(devices => {
                    console.debug(`Found ${devices.length} connected devices`, devices);
                    for (const device of devices) {
                        if (device.name == 'MicroIO_BLE') {  // FIXME: Hardcoded.
                            console.info('Re-connecting to', device.name, device);
                            connect(device);
                        }
                    }
                })
                .catch(error => {
                    console.error('Get device error:', error);
                    dom.status.innerHTML = `Error: ${error}`;
                });
            }

            function connect(device) {
                runtime.device = device;
                dom.status.innerHTML = `Connecting to ${device.name}...`;
                dom.connect.disabled = true;
                console.info('Connecting bluetooth device:' ,device.name, device.id);
                for (const [service_uuid, characteristic_uuid, handler] of config.bt.datasources) {
                    console.debug('Connecting characteristic:', characteristic_uuid, service_uuid);
                    device.gatt.connect()
                        .then(server => server.getPrimaryService(service_uuid.toLowerCase()))
                        .then(service => service.getCharacteristic(characteristic_uuid.toLowerCase()))
                        .then(characteristic => characteristic.startNotifications())
                        .then(characteristic => {
                            console.info('Connected charasteristic:', characteristic);
                            runtime.characteristics[characteristic_uuid] = characteristic;
                            characteristic.addEventListener('characteristicvaluechanged', (event) => {
                                console.debug('BLE Event received:', event.target.value, event);//, 'value:', handler(event));
                                console.debug('BLE Event:', 'Value', handler(event), '- UUID', event.target.uuid, '- timestamp', event.timeStamp);
                                const data = JSON.parse(handler(event));
                                console.debug('BLE Event JSON data:', data);
                                dom.status.innerHTML = `<strong>${JSON.stringify(data)}</strong> <small>&mdash; from ${device.name} ${event.target.uuid} @${event.timeStamp.toFixed()}ms</small>`;
                            });
                        })
                        .catch(error => {
                            dom.connect.disabled = false;
                            dom.status.innerHTML = 'Click to connect.';
                            console.error('Connect device error:', error)
                        });
                }
            }

            function request() {
                console.debug('Requesting Bluetooth Service:', config.bt.uuid);
                navigator.bluetooth.requestDevice({
                    // acceptAllDevices: true,
                    filters:[{services: [config.bt.uuid.toLowerCase()]}],
                    // optionalServices: ["battery_service"],
                })
                .then(device => {
                    connect(device);
                })
                .catch(error => {
                    console.error('Request device error:', error);
                    dom.status.innerHTML = `Error: ${error}`;
                });
            }

            dom.connect.addEventListener('click', function() {
                request();
            });
        </script>
    </body>
</html>
